struct AppConfig: Configuration, Codable, Sendable {
    var apiKey: String = ""
    var analyticsId: String = ""

    @MainActor
    private static let manager: Archery.ConfigurationManager<AppConfig> = {
        Archery.ConfigurationManager<AppConfig>(
            environmentPrefix: "APP"
        )
    }()

    @MainActor
    public static func override(_ key: String, value: Any) {
        manager.override(key, value: value)
    }

    @MainActor
    public static func clearOverrides() {
        manager.clearOverrides()
    }

    @MainActor
    public static func refresh() async {
        await manager.refresh()
    }

    @MainActor
    public static func setupRemoteConfig(url: URL, refreshInterval: TimeInterval) {
        manager.setupRemoteConfig(url: url, refreshInterval: refreshInterval)
    }

    public static var defaultValues: Self {
        Self(
            apiKey: "",
                analyticsId: ""
        )
    }

    public func validate() throws -> Bool {
        let validator = Archery.ConfigValidator()

        let rules: [Archery.ValidationRule] = [
        Archery.ValidationRule(path: "apiKey", type: .secretReference),
                Archery.ValidationRule(path: "analyticsId", type: .secretReference)
        ]

        for rule in rules {
            validator.addRule(rule)
        }

        let result = try validator.validate(self)
        if !result.isValid {
            throw Archery.ConfigurationError.validationFailed(result.report())
        }

        return true
    }

    @MainActor
    public static func validate() throws -> Bool {
        try manager.current.validate()
    }

    public static var schema: Archery.ConfigurationSchema {
        Archery.ConfigurationSchema(
            version: "1.0",
            properties: [
                "apiKey": Archery.PropertySchema(type: "string", secret: true),
                "analyticsId": Archery.PropertySchema(type: "string", secret: true)
            ],
            required: []
        )
    }

    @MainActor
    public static var apiKey: String {
        manager.current.apiKey
    }

    @MainActor
    public static var analyticsId: String {
        manager.current.analyticsId
    }

    @MainActor
    public var resolvedApiKey: String? {
        do {
            if let secret = try Archery.SecretsManager.shared.retrieve("apiKey") {
                return secret.value
            }
            return nil
        } catch {
            return nil
        }
    }

    @MainActor
    public static var resolvedApiKey: String? {
        manager.current.resolvedApiKey
    }

    @MainActor
    public var resolvedAnalyticsId: String? {
        do {
            if let secret = try Archery.SecretsManager.shared.retrieve("analyticsId") {
                return secret.value
            }
            return nil
        } catch {
            return nil
        }
    }

    @MainActor
    public static var resolvedAnalyticsId: String? {
        manager.current.resolvedAnalyticsId
    }
}