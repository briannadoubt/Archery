class SyncRepository {
    func profile(id: Int) -> String { "ok" }
}

protocol SyncRepositoryProtocol {
    func profile(id: Int) -> String
}

final class SyncRepositoryLive: SyncRepositoryProtocol, @unchecked Sendable {
    private let base: BaseBox
    private let enableCaching: Bool
    private let enableCoalescing: Bool
    private let enableTracing: Bool
    private let traceHandler: RepositoryTraceHandler?
    struct BaseBox: @unchecked Sendable {
        let value: SyncRepository
    }
    struct Box: @unchecked Sendable {
        let value: Any
    }
    private let state = State()
    private let clock = ContinuousClock()

    actor State {
        private var cache: [String: Box] = [:]
        private var inflight: [String: Task<Box, Error>] = [:]

        func cachedValue(for key: String) -> Box? {
            cache[key]
        }
        func setCached(_ value: Box, for key: String) {
            cache[key] = value
        }
        func inflightTask(for key: String) -> Task<Box, Error>? {
            inflight[key]
        }
        func inflightOrCreate(for key: String, make: () -> Task<Box, Error>) -> Task<Box, Error> {
            if let existing = inflight[key] {
                return existing
            }
            let task = make()
            inflight[key] = task
            return task
        }
        func clearInflight(for key: String) {
            inflight[key] = nil
        }
    }

    init(
        baseFactory: @escaping () -> SyncRepository = {
            SyncRepository()
        },
        enableCaching: Bool = false,
        enableCoalescing: Bool = false,
        enableTracing: Bool = false,
        traceHandler: RepositoryTraceHandler? = nil
    ) {
        self.base = BaseBox(value: baseFactory())
        self.enableCaching = enableCaching
        self.enableCoalescing = enableCoalescing
        self.enableTracing = enableTracing
        self.traceHandler = traceHandler
    }

    func profile(id: Int) -> String {
        let start = enableTracing ? clock.now : nil
        let result = base.value.profile(id: id)
        if let start = start, enableTracing {
            let end = clock.now
            traceHandler?(RepositoryTraceEvent(
                function: "profile(id: Int)",
                key: nil,
                start: start,
                end: end,
                duration: start.duration(to: end),
                cacheHit: false,
                coalesced: false,
                error: nil
            ))
        }
        return result
    }

    static func live(
        enableCaching: Bool = false,
        enableCoalescing: Bool = false,
        enableTracing: Bool = false,
        traceHandler: RepositoryTraceHandler? = nil
    ) -> SyncRepositoryProtocol {
        SyncRepositoryLive(
            baseFactory: {
                SyncRepository()
            },
            enableCaching: enableCaching,
            enableCoalescing: enableCoalescing,
            enableTracing: enableTracing,
            traceHandler: traceHandler
        )
    }

    static func make(
        in container: EnvContainer,
        enableCaching: Bool = false,
        enableCoalescing: Bool = false,
        enableTracing: Bool = false,
        traceHandler: RepositoryTraceHandler? = nil
    ) -> SyncRepositoryProtocol {
        if let cached: SyncRepositoryProtocol = container.resolve() {
            return cached
        }
        let repo = live(
            enableCaching: enableCaching,
            enableCoalescing: enableCoalescing,
            enableTracing: enableTracing,
            traceHandler: traceHandler
        )
        container.register(repo as SyncRepositoryProtocol)
        return repo
    }

    static func makeChild(
        from container: EnvContainer,
        enableCaching: Bool = false,
        enableCoalescing: Bool = false,
        enableTracing: Bool = false,
        traceHandler: RepositoryTraceHandler? = nil
    ) -> SyncRepositoryProtocol {
        let child = EnvContainer()
        container.merge(into: child)
        let repo = live(
            enableCaching: enableCaching,
            enableCoalescing: enableCoalescing,
            enableTracing: enableTracing,
            traceHandler: traceHandler
        )
        child.register(repo as SyncRepositoryProtocol)
        return repo
    }
}

final class MockSyncRepository: SyncRepositoryProtocol {
    var profileHandler: ((Int) -> String)?

    init() {
    }

    func profile(id: Int) -> String {
        if let handler = profileHandler {
            return handler(id)
        }
        fatalError("Not implemented in mock")
    }
}