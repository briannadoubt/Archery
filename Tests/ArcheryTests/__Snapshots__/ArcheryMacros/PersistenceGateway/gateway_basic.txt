enum PersistedValues {
    case username(String)
    case score(Int)

    var keyName: String {
        switch self {
        case .username:
            return "PersistedValues.username"
        case .score:
            return "PersistedValues.score"
        }
    }

    struct Gateway {
        private let store: SQLiteKVStore
        private let encoder = JSONEncoder()
        private let decoder = JSONDecoder()

        typealias Seed = (key: PersistedValues, value: any Encodable)

        init(url: URL, migrations: [SQLiteMigration] = [], seeds: [Seed] = []) throws {
            self.store = try SQLiteKVStore(
                url: url,
                migrations: migrations,
                seed: try Self.encodeSeeds(seeds, encoder: encoder)
            )
        }

        init(inMemory seeds: [Seed] = [], migrations: [SQLiteMigration] = []) throws {
            self.store = try SQLiteKVStore.inMemory(
                migrations: migrations,
                seed: try Self.encodeSeeds(seeds, encoder: encoder)
            )
        }

        func get<T: Codable>(_ key: PersistedValues, as type: T.Type = T.self, default defaultValue: T? = nil) async throws -> T? {
            guard let data = try await store.data(for: key.keyName) else {
                return defaultValue
            }
            return try decoder.decode(T.self, from: data)
        }

        func set(_ key: PersistedValues) async throws {
            switch key {
            case .username(let value):
                try await store.set(data: encoder.encode(value), for: "PersistedValues.username")
            case .score(let value):
                try await store.set(data: encoder.encode(value), for: "PersistedValues.score")
            }
        }

        func remove(_ key: PersistedValues) async throws {
            try await store.remove(key.keyName)
        }

        func changes() -> AsyncStream<SQLiteKVStore.Change> {
            store.changes()
        }

        func username(default defaultValue: String? = nil) async throws -> String? {
            guard let data = try await store.data(for: "PersistedValues.username") else {
                return defaultValue
            }
            return try decoder.decode(String.self, from: data)
        }
        func score(default defaultValue: Int? = nil) async throws -> Int? {
            guard let data = try await store.data(for: "PersistedValues.score") else {
                return defaultValue
            }
            return try decoder.decode(Int.self, from: data)
        }

        func setUsername(_ value: String) async throws {
            try await store.set(data: encoder.encode(value), for: "PersistedValues.username")
        }
        func setScore(_ value: Int) async throws {
            try await store.set(data: encoder.encode(value), for: "PersistedValues.score")
        }

        private static func encodeSeeds(_ seeds: [Seed], encoder: JSONEncoder) throws -> [String: Data] {
            try seeds.reduce(into: [String: Data]()) { partialResult, element in
                partialResult[element.key.keyName] = try encoder.encode(AnyEncodable(value: element.value))
            }
        }

        private struct AnyEncodable: Encodable {
            let value: any Encodable
            func encode(to encoder: Encoder) throws {
                try value.encode(to: encoder)
            }
        }
    }
}
