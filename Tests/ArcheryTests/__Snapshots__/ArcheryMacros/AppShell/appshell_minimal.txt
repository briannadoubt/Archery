struct MiniShell {
    enum Tab: CaseIterable { case home 
}

    struct ShellView: SwiftUI.View {
        @SwiftUI.State private var selection: Tab
        @SwiftUI.State private var paths: [Tab: [AnyHashable]]
        private var container: EnvContainer
        private let restorer: NavigationRestorer<Tab>?
        private let persistence: NavigationPersistence

        enum HomeRoute: NavigationRoute, Codable {
            case root
        }

        // Default builders; override with static funcs matching route types
        private static func defaultTabContent<Route>(_ route: Route, _ container: EnvContainer) -> some SwiftUI.View {
            SwiftUI.Text(String(describing: route))
        }

        private static func defaultDestination<Route>(_ route: Route, _ container: EnvContainer) -> some SwiftUI.View {
            SwiftUI.Text(String(describing: route))
        }

        init(
            selection: Tab = .home,
            base: EnvContainer = EnvContainer(),
            mergeFrom parent: EnvContainer? = nil,
            patch: ((inout EnvContainer) -> Void)? = nil,
            persistence: NavigationPersistence = .enabled(key: "archery.navigation.AppShellMacro")
        ) {
            self.persistence = persistence
            let working = EnvContainer()
            base.merge(into: working)
            parent?.merge(into: working)
            Self.register(into: &working)

            patch?(&working)
            self.container = working

            let initialPaths = Dictionary(uniqueKeysWithValues: Tab.allCases.map {
                    ($0, [AnyHashable]())
                })
            let restorer = persistence.mode == .enabled ? NavigationRestorer<Tab>(persistence: persistence) : nil
            let restored = restorer?.restore(tabDecoder: decodeTab, decoder: decodeRoute) ?? (nil, [:])
            var seededPaths = initialPaths
            restored.paths.forEach {
                seededPaths[$0.key] = $0.value
            }

            let initialSelection = restored.selection ?? selection
            self._selection = SwiftUI.State(initialValue: initialSelection)
            self._paths = SwiftUI.State(initialValue: seededPaths)
            self.restorer = restorer
        }

        var body: some SwiftUI.View {
            SwiftUI.TabView(selection: $selection) {
                SwiftUI.NavigationStack(path: binding(for: .home, as: HomeRoute.self)) {
                    Self.defaultTabContent(.root, container)
                }
                .navigationDestination(for: HomeRoute.self) { route in
                    Self.defaultDestination(route, container)
                }


                .tabItem {
                    SwiftUI.Label("home", systemImage: "circle")
                }
                .tag(Tab.home)
            }
            .environment(\.archeryContainer, container)
            .onChange(of: selection) { _ in
                persistNavigation()
            }
            .onChange(of: paths) { _ in
                persistNavigation()
            }
        }

        private func binding<Route: Hashable>(for tab: Tab, as _: Route.Type) -> SwiftUI.Binding<[Route]> {
            SwiftUI.Binding(
                get: {
                    (paths[tab] as? [Route]) ?? []
                },
                set: { newValue in
                    paths[tab] = newValue.map {
                        $0 as AnyHashable
                    }
                }
            )
        }
        private func encodePath(for tab: Tab) -> [String] {
            switch tab {
            case .home:
                return (paths[.home] as? [HomeRoute])?.map(\.navigationIdentifier) ?? []
            }
        }

        private func decodeRoute(for tab: Tab, identifier: String) -> AnyHashable? {
            switch tab {
            case .home:
                return HomeRoute.decodeNavigationIdentifier(identifier)
            }
        }

        private func encodeTab(_ tab: Tab) -> String? {
            switch tab {
            case .home:
                return "home"
            }
        }

        private func decodeTab(_ identifier: String) -> Tab? {
            switch identifier {
            case "home":
                return .home
            default:
                return nil
            }
        }

        private func persistNavigation() {
            guard let restorer else {
                return
            }
            let encoder: NavigationRestorer<Tab>.Encoder = { tab, element in
                switch tab {
                case .home:
                    return (element as? HomeRoute)?.navigationIdentifier
                }
            }
            restorer.persist(selection: selection, paths: paths, tabEncoder: encodeTab, encoder: encoder)
        }

        static func register(into container: inout EnvContainer) {
            container.registerFactory {
                Self.init()
            }
            container.register(Tab.allCases)



        }

        static func previewContainer(seed: ((inout EnvContainer) -> Void)? = nil, mergeFrom parent: EnvContainer? = nil) -> EnvContainer {
            let c = EnvContainer()
            parent?.merge(into: c)
            Self.register(into: &c)


            seed?(&c)
            return c
        }
    }

    #if DEBUG
    struct ShellView_Previews: SwiftUI.PreviewProvider {
        static var previews: some SwiftUI.View {
            let container = ShellView.previewContainer()
            return SwiftUI.Group {
                ForEach(Array(Tab.allCases), id: \.self) { tab in
                    ShellView(selection: tab, mergeFrom: container)
                        .environment(\.archeryContainer, container)
                        .previewDisplayName(String(describing: tab))
                }
            }
        }
    }
    #endif
}