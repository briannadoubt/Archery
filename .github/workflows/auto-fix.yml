name: Auto-fix CI Failures

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  auto-fix:
    name: Analyze and Fix
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: macos-26
    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.0.app

      - name: Download workflow logs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runId = context.payload.workflow_run.id;

            // Get jobs for the failed run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            // Find failed jobs and get their logs
            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            let errorLog = `# CI Failure Report\n\n`;
            errorLog += `**Run ID:** ${runId}\n`;
            errorLog += `**Branch:** ${context.payload.workflow_run.head_branch}\n`;
            errorLog += `**Commit:** ${context.payload.workflow_run.head_sha}\n\n`;

            for (const job of failedJobs) {
              errorLog += `## Failed Job: ${job.name}\n\n`;

              // Get failed steps
              const failedSteps = job.steps.filter(step => step.conclusion === 'failure');
              for (const step of failedSteps) {
                errorLog += `### Step: ${step.name}\n`;
                errorLog += `- Status: ${step.conclusion}\n`;
                errorLog += `- Started: ${step.started_at}\n`;
                errorLog += `- Completed: ${step.completed_at}\n\n`;
              }
            }

            // Try to get full logs
            try {
              const logs = await github.rest.actions.downloadWorkflowRunLogs({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });
              errorLog += `\n## Full logs available at: ${context.payload.workflow_run.html_url}\n`;
            } catch (e) {
              errorLog += `\n## Could not download full logs: ${e.message}\n`;
            }

            fs.writeFileSync('/tmp/ci-failure.md', errorLog);
            console.log(errorLog);

      - name: Run Claude Code to fix issues
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            The CI workflow failed on this branch. Your task is to:

            1. Read the failure report at /tmp/ci-failure.md
            2. Run `swift build` and `swift test` to reproduce the errors locally
            3. Analyze the root cause of the failures
            4. Fix the issues in the code
            5. Verify your fix by running the build/tests again

            Important guidelines for this Archery project:
            - This is a Swift macro architecture framework targeting Swift 6.2 and Xcode 26
            - If a macro doesn't work, fix the macro - don't rebuild without it
            - Ensure any library changes are showcased in the ArcheryShowcase app
            - All macros must have snapshot tests
            - Support all Apple platforms: iOS, macOS, tvOS, watchOS, visionOS

            After fixing, commit your changes with a clear message explaining what was fixed.
          allowed_tools: "Bash,Read,Write,Edit,Glob,Grep"
          timeout_minutes: 30

      - name: Push fixes
        if: success()
        run: |
          git config user.name "claude-code[bot]"
          git config user.email "claude-code[bot]@users.noreply.github.com"
          git push origin ${{ github.event.workflow_run.head_branch }}
