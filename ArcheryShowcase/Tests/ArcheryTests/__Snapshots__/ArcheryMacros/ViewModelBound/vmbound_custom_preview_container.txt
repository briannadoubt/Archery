struct SampleView {
    static func makePreviewContainer() -> EnvContainer { EnvContainer() }

    @SwiftUI.Environment(\.archeryContainer) private var __archeryEnv
    @SwiftUI.State private var vmHolder = __ArcheryVMHolder(factory: { SampleVM() })

    var vm: SampleVM {
        vmHolder.value(container: __archeryEnv)
    }

    @SwiftUI.ViewBuilder var bodyWithVMLoad: some SwiftUI.View {
        body.task {
            let anyVM: Any = vm
            if let loadable = anyVM as? ArcheryLoadable {
                await loadable.load()
            }
        }
    }

    static func previewContainer(seed: ((inout EnvContainer) -> Void)? = nil) -> EnvContainer {
        var c = EnvContainer()
        c.registerFactory {
            SampleVM()
        }
        seed?(&c)
        return c
    }

    #if DEBUG
    @available(iOS 17.0, macOS 14.0, tvOS 17.0, watchOS 10.0, *)
    struct SampleViewPreviewModifier: SwiftUI.PreviewModifier {
        /// Use with `#Preview(traits: .modifier(SampleViewPreviewModifier())) { SampleView() }`
        /// Optionally pass a seeding closure to register mocks: `.modifier(SampleViewPreviewModifier { c in /* c.register(mock) */ })`
        typealias Body = SwiftUI.AnyView
        typealias Context = Void
        let seed: ((inout EnvContainer) -> Void)?
        init(seed: ((inout EnvContainer) -> Void)? = nil) {
            self.seed = seed
        }
        func body(content: Content, context: Context) -> Body {
            let container = SampleView.makePreviewContainer()
            return SwiftUI.AnyView(content.environment(\.archeryContainer, container))
        }
    }
    #endif

    @MainActor @Observable fileprivate final class __ArcheryVMHolder {
        fileprivate var cached: SampleVM?
        fileprivate let factory: @MainActor () -> SampleVM
        init(factory: @escaping @MainActor () -> SampleVM = {
                SampleVM()
            }) {
            self.factory = factory
        }
        func value(container: EnvContainer?) -> SampleVM {
            if let cached {
                return cached
            }
            if let container {
                if let resolved: SampleVM = container.resolve() {
                    self.cached = resolved
                    return resolved
                }
                fatalError("Archery: EnvContainer missing registration for SampleVM. Register it in EnvContainer or supply a factory.")
            }
            let created = factory()
            self.cached = created
            return created
        }
    }

    #if DEBUG
    struct SampleView_Previews: SwiftUI.PreviewProvider {
        static var previews: some SwiftUI.View {
            let container = SampleView.makePreviewContainer()
            return SampleView()
                .environment(\.archeryContainer, container)
                .task {
                    if let vm: SampleVM = container.resolve(),
                       let loadable = (vm as Any) as? ArcheryLoadable {
                        await loadable.load()
                    }
                }
        }
    }
    #endif
}